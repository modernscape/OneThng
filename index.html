<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />
    <link rel="shortcut icon" href="favicon.ico" />
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> -->

    <!-- ※基本共通設定 -->

    <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
        <title>ページのタイトル</title>
        <meta property="og:title" content="ひとつのことシート" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://modernscape.github.io/OneThng/" />
        <meta property="og:image" content="https://modernscape.github.io/OneThng/img/manual.png" />
        <meta property="og:site_name" content="ひとつのことシート" />
        <meta property="og:description"
            content="マインドフルネス,集中力,OneThing,シングルタスク,マルチタスク,Win Win,自己啓発,夢,タスク管理,ひとつのこと,集中,ビジネススキル,google,瞑想,webツール" />

        <!-- ※Twitter共通設定 -->
        <meta name="twitter:card" content="summary_large_image" />

        <title>ひとつのことシート</title>
        <style>
            input {
                background-color: rgba(0, 0, 0, 0);
                color: #fff;
                padding: 0 5px;
                border: 0;
            }

            .center {
                text-align: center;
            }

            .plusBtn {
                text-align: center;
                border: 0;
                font-weight: bold;
                color: aqua;
                cursor: pointer;
            }

            .plusBtn:hover {
                color: rgb(247, 223, 3);
            }

            .plus_item {
                padding: 5px 0;
                text-align: right;
            }

            .plus_category {
                padding: 0 10px;
            }

            .container,
            .txt,
            .textMetrics {
                font: inherit;
            }

            .textMetrics {
                display: inline-block;
                position: absolute;
                height: 0;
                overflow: hidden;
                white-space: nowrap;
                clip: rect(0 0 0 0);
                clip-path: inset(50%);
            }

            .deleteBtn {
                border: 0;
                padding: 0 5px;
                cursor: pointer;
            }

            .deleteBtn img {
                width: 20px;
                height: 20px;
                padding: 3px;
                vertical-align: middle;
            }

            .deleteBtn img:hover {
                opacity: 0.3;
            }

            table {
                margin: 0 auto;
            }

            table td {
                border-color: rgb(95, 95, 95);
            }

            .txt {
                color: rgb(83, 170, 251);
            }

            .active {
                color: rgb(255, 0, 123);
                font-weight: bold;
                background-color: rgb(251, 186, 232);
            }

            .inactive {
                background-color: rgba(251, 186, 231, 0);
            }

            p.note {
                color: rgb(161, 161, 161);
                padding: 5px 1em;
                position: fixed;
                left: 50%;
                transform: translateX(-50%);
                bottom: 5px;
                pointer-events: none;
                border: 1px solid rgb(161, 161, 161);
                width: 90%;
                text-align: center;
            }

            #contextmenu,
            #contextmenu_out {
                display: none;
                position: fixed;
                left: 0px;
                top: 0px;
                border: 0;
                background-color: rgba(41, 41, 41, 0.832);
                padding: 3px 10px;
            }

            #contextmenu li,
            #contextmenu_out li {
                cursor: pointer;
                list-style-type: none;
                color: #fff;
            }

            .td_category {
                position: relative;
            }

            .input_category {
                width: 100%;
                height: 60px;
                box-sizing: border-box;
                font-weight: bold;
                font-size: 110%;
            }

            textarea {
                background-color: #ff000000;
                color: rgb(153, 171, 162);
                resize: none;
                border: 0;
                vertical-align: bottom;
                width: 100%;
                height: 60px;
                box-sizing: border-box;
            }

            .catDeleteBtn,
            .catMoveBtn {
                display: none;
                width: 20px;
                height: 20px;
                position: absolute;
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
            }

            .catMoveBtn {
                left: 5px;
            }

            td:hover .catDeleteBtn,
            td:hover .catMoveBtn {
                display: inline;
            }

            td:hover .firstCat {
                display: none;
            }

            .content {
                overflow: auto;
                padding: 1em;
            }

            .txt-half {
                color: rgb(174, 174, 174);
            }

            h1.title {
                width: 100%;
            }

            #app {
                margin-bottom: 120px;
            }

            .hasItem {
                background-color: rgba(0, 170, 255, 0.49);
            }

            .evaluationSelect {
                font-size: 120%;
                background-color: #ff000000;
                color: #fff;
                border: 0;
            }

            .inputDone {
                text-decoration: line-through;
            }

            .manual {
                position: fixed;
                top: 5px;
                right: 10px;
                /* border: 1px solid #ccc; */
                text-decoration: none;
                padding: 2px 7px;
                color: #000;
                background-color: #ccc;
                border-radius: 3px;
            }
        </style>
    </head>

<body onContextmenu="return false;">

    <h1 class="title center">頭がいっぱいにならない「ひとつのことシート」</h1>
    <div><a href="img/manual.png" target="manual" class="manual">使い方</a></div>
    <div id="app">
        <div id="contextmenu">
            <ul>
                <!-- <li v-on:click="addItem">タスクを追加</li> -->
                <li v-on:click="addItemPrev">＋ 行を追加（上に）</li>
                <li v-on:click="deleteItemWithMenu">ー 行を削除</li>
                <li v-on:click="addCategoryPrev">＋ 列を追加（左に）</li>
                <li v-on:click="deleteCategoryWithMenu">ー 列を削除</li>
            </ul>
        </div>
        <div id="contextmenu_out">
            <ul>
                <li v-on:click="addItem">タスクを追加</li>
                <li v-on:click="addCategory">カテゴリーを追加</li>
            </ul>
        </div>
        <div class="content">
            <table id="table">
                <tr class="center">
                    <td class="txt-half">実行</td>
                    <td class="txt-half">実施する日</td>
                    <td class="txt-half">評価</td>
                    <td v-for="cat in categories" :class="cat.title" :key="cat.id" :data-id="cat.id"
                        class="td_category">
                        <input type="text" v-model="cat.title" v-on:change="writeCategories_app"
                            class="input_category center" placeholder="カテゴリー">
                        <img src="img/arrow.png" :class="{ firstCat: cat.id == 0 }" @click="moveCategory"
                            class="catMoveBtn">
                        <img src="img/remove-button.png" class="catDeleteBtn" @click="deleteCategoryWithBtn">
                    </td>
                    <td class="plusBtn plus_category" v-on:click="addCategory">列を追加 ＋</td>
                </tr>
                <tr style="height:60px">
                    <td colspan="2" class="txt-half">ツール<br>コンテンツ</td>
                    <td></td>
                    <td v-for="cat in categories" :class="cat.tool" :key="cat.id" :data-id="cat.id" class="center">
                        <textarea v-model="cat.tool" v-on:change="writeCategories_app"
                            class="center">{{ cat.tool }}</textarea>
                    </td>
                </tr>
                <tr v-for="item in items" :key="item.id" :data-id="item.id" class="itemRow">
                    <td :class="{ hasItem: item.title != '' }" class="center"><input type="checkbox" name="" id=""
                            :checked=item.done v-on:change="updateDone" class="doneBtn">
                    </td>
                    <td><input type="date" :value="item.date" v-on:change="updateDate" class="dateField datepicker">
                    </td>
                    <td><select class="evaluationSelect" name="" id="" v-on:change="updateEvaluation"
                            :value="item.evaluation">
                            <option value=" "> </option>
                            <option value="◉">◉</option>
                            <option value="◎">◎</option>
                            <option value="○">○</option>
                            <option value="△">△</option>
                            <option value="x">x</option>
                        </select>
                    </td>
                    <td v-for="cat in categories" :class="cat.title" :key="cat.id" :data-id="cat.id">
                        <div class="container" v-if="true">
                            <input type="text" :value='cat.id==item.cat ? item.title : ""' v-on:input="inputHundler"
                                :class="{ active: item.date != '' && cat.id==item.cat,
                                 inactive: item.date == '' && cat.id==item.cat,
                                inputDone: item.done }" class="txt" v-on:focus="activateCat(cat.id, $event)"
                                :placeholder="item.title != '' ? '' : '行動' " :style="styles(item)">
                            <span class="textMetrics" aria-hidden="true"></span>
                        </div>
                    </td>
                    <td v-on:click="deleteItemWithBtn" class="deleteBtn"><img src="img/remove-button.png"></td>
                </tr>
                <tr>
                    <td :colspan="4" class="plusBtn plus_item" v-on:click="addItem">行を追加 ＋</td>
                </tr>
            </table>
            <p class="note">
                ① 実施する<b>「行動」</b>を追加<br>
                ② 行動は1行に<b>1つのみ</b><br>
                ③「実施する日」設定 → <b>自動ソート</b>
            </p>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>

    <script type="module">
        const table = document.getElementById('table');

        var activeCat = 0;
        var activeInput;
        const defaultWidth = 217;

        let key_items = 'OneThing_key_items';
        let key_categories = 'OneThing_key_categories';
        let key_written = 'OneThing_key_written';

        let app = new Vue({
            el: "#app",
            data: {
                items: [
                    {
                        "cat": 0,
                        "date": "",
                        "done": false,
                        "evaluation": "",
                        "id": 0,
                        "title": "ブログを書く",
                        "active": false,
                        "width": 0
                    }
                ],
                categories: [
                    {
                        "id": 0,
                        "title": "ビジネス",
                        "tool": "ブログ"
                    }
                ]
            },
            computed: {
                styles() {
                    return (item) => {
                        let w = 0;
                        if (item.width != undefined) w = item.width;
                        if (w <= defaultWidth) w = defaultWidth;
                        // return "width:" + ((item.width == undefined) ? '217px' : item.width + 'px')
                        return 'width:' + w + 'px'
                    }
                }
            },
            methods: {
                loadData: function (ary0, ary1) {
                    this.items = ary0;
                    console.log(this.items[0]);
                    this.categories = ary1;
                    console.log(this.categories[0]);
                },
                addItem: function (e) {
                    document.getElementById('contextmenu').style.display = "none";
                    // const result = prompt("タスク名", "task");
                    let l = this.items.length;
                    const item =
                    {
                        "cat": 0,
                        "date": "",
                        "done": false,
                        "evaluation": "",
                        "id": l,
                        "title": ""
                    }
                    this.items.push(item);
                    saveData();
                },
                addItemPrev: function (e) {
                    document.getElementById('contextmenu').style.display = "none";
                    var elements = document.getElementsByClassName('itemRow');
                    elements = [].slice.call(elements);
                    let tr = activeInput.parentNode.parentNode.parentNode
                    var itemIndex = elements.indexOf(tr);
                    let l = this.items.length;
                    const item =
                    {
                        "cat": 0,
                        "date": "",
                        "done": false,
                        "evaluation": "",
                        "id": l,
                        "title": ""
                    }
                    this.items.splice(itemIndex, 0, item);
                    // writeItems();
                    saveData();
                },
                addCategory: function () {
                    const result = prompt("追加するカテゴリーは？", "");
                    if (result) {
                        let l = this.categories.length;
                        const cat =
                        {
                            "id": l,
                            "title": result
                        }
                        this.categories.push(cat);
                        // writeCategories();
                        saveData();
                    }
                },
                updateItemOrder: function () {
                    for (let index = 0; index < this.items.length; index++) {
                        const item = this.items[index];
                        item.id = index;
                    }
                },
                addCategoryPrev: function () {
                    const result = prompt("追加するカテゴリーは？", "");
                    if (result) {
                        let l = this.categories.length;
                        const category =
                        {
                            "id": l,
                            "title": result
                        }
                        this.categories.splice(activeCat, 0, category);
                        // writeCategories();
                        saveData();
                        this.shiftRightItemCat(activeCat);
                        // writeItems();
                        saveData();
                    }
                },
                updateCategoryOrder: function () {
                    for (let index = 0; index < this.categories.length; index++) {
                        const cat = this.categories[index];
                        cat.id = index;
                    }
                },
                shiftRightItemCat: function (after) {
                    // itemのcatがafter以上場合1大きく
                    for (let index = 0; index < this.items.length; index++) {
                        const item = this.items[index];
                        if (item.cat >= after) {
                            item.cat++;
                        }
                    }
                },
                shiftLeftItemCat: function (after) {
                    // itemのcatがafter以上場合1小さく
                    for (let index = 0; index < this.items.length; index++) {
                        const item = this.items[index];
                        if (item.cat >= after) {
                            item.cat--;
                        }
                    }
                },
                deleteCategoryWithMenu: function (e) {
                    var result = window.confirm('このカテゴリーを削除しますか？');
                    if (result) {
                        this.deleteCategory(activeCat);
                    }
                },
                deleteCategoryWithBtn: function (e) {
                    var btn = e.target;
                    var elements = document.getElementsByClassName('catDeleteBtn');
                    elements = [].slice.call(elements);
                    var catIndex = elements.indexOf(btn);
                    const cat = app.categories[catIndex];
                    var result = window.confirm('〔 ' + cat.title + ' 〕を削除しますか？');
                    if (result) {
                        this.deleteCategory(catIndex);
                    }
                },
                deleteCategory: function (index) {
                    // 該当の行（item.cat == index）となる全ての行を削除
                    var itemsToDelete = [];
                    for (let j = 0; j < app.items.length; j++) {
                        const item = app.items[j];
                        if (item.cat == index) {
                            itemsToDelete.push(item)
                        }
                    }

                    app.deleteItems(itemsToDelete);
                    this.shiftLeftItemCat(index);
                    // writeItems();
                    saveData();

                    this.categories.splice(index, 1);
                    // writeCategories();
                    saveData();
                },
                moveCategory: function (e) {
                    var btn = e.target;
                    var elements = document.getElementsByClassName('catMoveBtn');
                    elements = [].slice.call(elements);
                    var catIndex = elements.indexOf(btn);
                    const from = catIndex;
                    const to = catIndex - 1;
                    if (to < 0) {
                        return
                    }
                    const value = app.categories[from];
                    const tail = app.categories.slice(from + 1);
                    app.categories.splice(from);
                    Array.prototype.push.apply(app.categories, tail);
                    app.categories.splice(to, 0, value);
                    // writeCategories();
                    saveData();

                    // 全てのitemのitem.catも入れ替える
                    for (let index = 0; index < app.items.length; index++) {
                        const item = app.items[index];
                        if (item.cat == to) {
                            item.cat = from
                        } else if (item.cat == from) {
                            item.cat = to;
                        }
                    }
                    // writeItems();
                    saveData();
                },
                inputHundler: function (e) {
                    var cat = 0;
                    const curInput = e.target;
                    const tr = curInput.parentNode.parentNode.parentNode;

                    var elements = document.getElementsByTagName("tr");
                    elements = [].slice.call(elements);
                    var itemIndex = elements.indexOf(tr) - 2;
                    const item = app.items[itemIndex];

                    var inputArray = [];
                    for (let index = 0; index < this.categories.length; index++) {
                        const td = tr.children[index + 3];
                        const input = td.firstElementChild.firstElementChild;
                        inputArray.push(input);
                        if (input == curInput) {
                            cat = index;
                        } else {
                            input.value = '';
                        }
                        item.title = curInput.value;
                    }
                    const span = e.target.nextElementSibling;
                    span.textContent = curInput.value;
                    let w = Math.max(span.clientWidth, defaultWidth);
                    // curInput.style.width = `${span.clientWidth}px`;
                    curInput.style.width = `${w}px`;
                    item.width = w;//span.clientWidth;
                    item.cat = cat;
                    // writeItems();
                    saveData();
                },
                // alltextMetrics: function () {
                //     var inputs = document.getElementsByClassName('txt');
                //     inputs = [].slice.call(inputs);
                //     console.log(inputs);
                //     for (let index = 0; index < app.items.length; index++) {
                //         console.log(index);
                //         const item = app.items[index];
                //         let input = inputs[index];
                //         console.log(input);
                //         console.log(item.width);
                //         if (item.width == undefined) {
                //             console.log('widthなし！');
                //             item.width = defaultWidth;
                //             console.log(item.width);
                //         }
                //         input.style.width = `${item.width}px`;
                //     }
                // },
                activateCat: function (cat, e) {
                    activeCat = cat;
                    activeInput = e.target;
                },
                deleteItemWithMenu: function (e) {
                    var elements = document.getElementsByClassName('itemRow');
                    elements = [].slice.call(elements);
                    let tr = activeInput.parentNode.parentNode.parentNode
                    var itemIndex = elements.indexOf(tr);
                    app.deleteItem(itemIndex);
                },
                deleteItemWithBtn: function (e) {
                    var result = window.confirm('この行を削除しますか？');
                    if (result) {
                        var btn = e.target;
                        var elements = document.getElementsByClassName('deleteBtn');
                        elements = [].slice.call(elements);
                        var itemIndex = elements.indexOf(btn);
                        const item = app.items[itemIndex - 2];
                        app.deleteItem(itemIndex);
                    }
                },
                deleteItem: function (index) {
                    app.items.splice(index, 1);
                    // writeItems();
                    saveData();
                },
                deleteItems: function (ary) {


                    console.log(ary);
                    // filterを使う
                    const newSource = app.items.filter((val) => {
                        return !ary.includes(val);
                    });

                    console.log(newSource);
                    app.items = newSource;

                    // app.items.splice(index, 1);
                    // writeItems();
                    saveData();
                },
                updateDone: function (e) {
                    var btn = e.target;
                    var elements = document.getElementsByClassName('doneBtn');
                    elements = [].slice.call(elements);
                    var itemIndex = elements.indexOf(btn);
                    const item = app.items[itemIndex];
                    item.done = !item.done;
                    writeItems();
                },
                updateDate: function (e) {
                    var btn = e.target;
                    var elements = document.getElementsByClassName('dateField');
                    elements = [].slice.call(elements);
                    var itemIndex = elements.indexOf(btn);
                    const item = app.items[itemIndex];
                    item.date = btn.value;
                    this.sort();
                    // writeItems();
                    saveData();

                    // 日付が空の時の処理
                },
                updateEvaluation: function (e) {
                    var select = e.target;
                    var item = this.itemForElement('evaluationSelect', e)
                    item.evaluation = select.value;
                    // writeItems();
                    saveData();
                },
                sort: function (e) {
                    app.items.sort(function (x, y) {
                        // var firstDate = new Date(x.date),
                        //     SecondDate = new Date(y.date);
                        var firstDate = x.date,
                            SecondDate = y.date;

                        if (firstDate == '') return 1;
                        if (SecondDate == '') return -1;
                        if (firstDate < SecondDate) return -1;
                        if (firstDate > SecondDate) return 1;

                        return 0;
                    });
                },
                itemForElement: function (className, e) {
                    var btn = e.target;
                    var elements = document.getElementsByClassName(className);
                    elements = [].slice.call(elements);
                    var index = elements.indexOf(btn);
                    var item = app.items[index];
                    return item;
                },
                removeRow: function () {
                    this.items.pop();
                    // writeItems();
                    saveData();
                },
                writeItems_app: function () {
                    saveData();
                },
                writeCategories_app: function () {
                    // writeCategories();
                    saveData();
                }
            },
            created: function () {
                console.log('created!');
            },
            mounted: function () {
                console.log('mounted!');
            }
        });

        // onValue(oneThingRef, (snapshot) => {
        //     const data = snapshot.val();
        //     app.loadData(data.items, data.categories);
        //     app.textMetrics();


        // });

        document.addEventListener('DOMContentLoaded', function (e) {

            // loadData
            if (localStorage[key_written] == 'done') {
                loadData();
                // app.alltextMetrics();
            }

        }, false)

        function loadData() {
            let items = localStorage[key_items];
            app.items = JSON.parse(items);
            let categories = localStorage[key_categories];
            app.categories = JSON.parse(categories);
        }

        function saveData() {
            writeItems();
            writeCategories();
            localStorage[key_written] = 'done'
        }

        function writeItems() {
            console.log('writeItems!');
            app.updateItemOrder();
            let json = JSON.stringify(app.items, undefined, 1);
            localStorage[key_items] = json;
        }

        function writeCategories() {
            console.log('writeCategories!');
            app.updateCategoryOrder();
            let json = JSON.stringify(app.categories, undefined, 1);
            localStorage[key_categories] = json;
        }

        function writeDefaultData() {
            let items = [{
                "cat": 0,
                "date": "",
                "done": false,
                "evaluation": "",
                "id": 0,
                "title": "ブログを書く",
                "active": false
            }];
            let categories = [{
                "id": 0,
                "title": "ビジネス",
                "tool": "ブログ"
            }];

            localStorage[key_items] = items;
            localStorage[key_categories] = categories;
        }

        window.onload = function () {
            document.body.addEventListener('contextmenu', function (e) {
                var str = (e.target.className == 'txt') ? 'contextmenu' : 'contextmenu_out';
                var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
                document.getElementById(str).style.left = e.pageX + "px";
                document.getElementById(str).style.top = e.pageY - scrollY + "px";
                document.getElementById(str).style.display = "block";
            });
            document.body.addEventListener('click', function (e) {
                document.getElementById('contextmenu').style.display = "none";
                document.getElementById('contextmenu_out').style.display = "none";
            });
        }


    </script>
    <!-- 
    <script>
        $(() => {
            $("input.datepicker").datepicker();
        });

        $(() => {
            if (is_iOS == false) {
                console.log('not!');
                $("input[type=date]").attr('type', 'text');
                $("input.datepicker").datepicker();
            }
        });

        function is_iOS() {
            (navigator.userAgent.indexOf('iPhone;') > -1 || navigator.standalone != undefined) ? true : false;
        }
    </script> -->
</body>

</html>